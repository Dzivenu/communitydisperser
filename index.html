<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        
        <h1 id="UserHeader"></h1>
        <title>Community Disperser!</title>
        <ul id="UserSteemData"><h1>User Information:</h1></ul>
        <center>
        <style>
            #zone_chat strong {
                color: white;
                background-color: black;
                padding: 2px;
            }
        </style>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

        <!--Remove comment and comment out other source to use node modules lib
        <script src="./node_modules/steem/dist/steem.min.js"></script>
        -->
        <script src="./steem.min.js"></script>

    </head>
 
    <body>

        <img src="./steemthirdparty.png"></img>
        
        <h1>Community Disperser!</h1>

        <p>The username list does not need @ symbols for usernames also remove any spaces and use , to seperate them.</p>

        <h2>Example:</h2>
        <p>giftedgaia,papa-pepper,good-karma,winstonwolfe</p>

        <form action="/" method="post" id="userlist_form">
            <input type="text" name="message" id="message" placeholder="Users to send to..." size="50" autofocus />
            <input type="text" name="amount" id="amount" placeholder="The amount of steem to send to every user..." size="40" autofocus />
            <input type="text" name="memo" id="memo" placeholder="The memo to include with every transfer..." size="40" autofocus />
            <input type="submit" id="send_message" value="Send" />
        </form>

        <section id="result_zone">
            
        </section>
    </center>
    <br/>
    <br/>
    <p>All appreciation to Fabien @adcpm for the steem js lib.</p>
        <script>

            // The username and activekey is requested, stored in the var username and displayed in the title
            var username = prompt('What\'s your username?');
            
            var activekey =prompt('What\'s your active key?');
            
            document.title = username + ' - ' + document.title;

            steem.config.set('websocket','wss://node.steem.ws');


            steem.api.getAccounts([username], function(err, response){

                if(response[0] != null) {
                    $('#UserSteemData').append('<li>' + "Username: " + response[0].name + '</li>');
                    $('#UserSteemData').append('<li>' + "Memo Key: " + response[0].memo_key + '</li>');
                    $('#UserSteemData').append('<li>' + "Steem Balance: " + response[0].balance + '</li>');
                }
                else {
                    $('#result_zone').prepend('<p><em>' + "That is not a valid username, please use your steem username." + '</em></p>');
                };
            });

            
            
            // When the form is fired, the results are validated and then displayed on the page.
            $('#userlist_form').submit(function () {
                var message = $('#message').val();
                var amount = $('#amount').val();
                var memo = $('#memo').val();
                var TOKEN = " STEEM";

                

                insertMessage(username, message, amount, memo);
                // Empties the input forms and puts the focus back on the user input field.
                $('#amount').val('');
                $('#memo').val('');
                $('#message').val('').focus(); 

                var userdispersallist = message.split(',');
                
                $.each(userdispersallist, function (index, value){
                    /*steem.broadcast.transfer(activekey, username, "steemstars-gtc", "1.000 STEEM", "testing", function(err,   result) {
                    console.log(err, result);
                    });*/
                    steem.api.lookupAccountNames([value], function(err, lookupresult) {

                        console.log(err, lookupresult);
                        
                        if(lookupresult[0] != null ) {
                            
                            steem.broadcast.transfer(activekey, username, value, amount.concat(TOKEN), memo, function(err, transferresult) 
                            {
                                console.log(transferresult);
                                
                                $('#result_zone').prepend('<p><em>' + value + " " + transferresult + '</em></p>');
                            });
                        }
                        else{
                            $('#result_zone').prepend('<p><em>' + "Something went wrong, likely this username is not real: " + value + '</em></p>');
                        };
                    });
                });
                 // Blocks 'classic' sending of the form
                return false;
            });
            
            

             //Adds a message to the page
            function insertMessage(username, message, amount, memo) {
                $('#result_zone').prepend('<p><strong>' + username + '</strong> ' + message + " " + amount + " " + memo + '</p>');
            };

            
        </script>
    </body>
</html>